# Что изменилось: Реальные API запросы

## ✅ Главные изменения

### 1. **Автоматические запросы при выборе source**
- При выборе Data Source в инспекторе **автоматически** отправляется запрос к API
- Данные загружаются в фоне и кешируются
- **Не нужно** нажимать кнопку - запрос делается сам

### 2. **Canvas показывает реальные данные**
- Раньше: данные только из `sample.payload`
- **Теперь**: данные из реального API ответа
- Блоки обновляются автоматически после загрузки

### 3. **Preview использует реальные данные**
- Раньше: preview показывал `sample.payload`
- **Теперь**: делает реальные запросы к API и показывает результат
- При открытии /preview автоматически загружаются все данные

### 4. **Sample только для схемы**
- Раньше: sample использовался как данные
- **Теперь**: sample нужен ТОЛЬКО чтобы увидеть доступные поля в dropdown
- Реальные данные берутся из API

### 5. **Убран автоматический маппинг**
- Раньше: "Автоматический режим" и кнопка "Настроить"
- **Теперь**: ВСЕГДА ручной выбор полей
- Лейбл изменен: "Схема данных (для выбора полей)"

### 6. **Кнопка "Обновить данные"**
- Раньше: "Тест запроса"
- **Теперь**: "Обновить данные" - перезагружает из API
- Показывает статус: ⏳ Загрузка / ✓ Загружено / ✗ Ошибка

---

## Как это работает

### Workflow

```
1. Выбираешь Data Source в инспекторе
   ↓
2. Автоматически отправляется запрос к API
   ↓
3. Результат кешируется в apiDataCache
   ↓
4. Выбираешь Sample (схему)
   ↓
5. Настраиваешь маппинг полей
   ↓
6. Блок заполняется РЕАЛЬНЫМИ данными из API
```

### Пример

**Data Source**:
- Endpoint: `https://jsonplaceholder.typicode.com/users/1`
- Type: REST
- Method: GET

**Sample** (только для схемы):
```json
{
  "id": 1,
  "name": "John Doe",
  "email": "john@example.com"
}
```

**Маппинг** (ручной):
- `title` → `name`
- `description` → `email`

**Результат**: Блок показывает **реальные данные из API**, а не из sample!

---

## Технические детали

### Изменения в коде

**studio-workspace.tsx**:
- Добавлен `apiDataCache` state для хранения реальных данных
- `useEffect` автоматически загружает данные при выборе source
- Canvas рендеринг использует `apiDataCache` вместо `sample.payload`

**studio-preview.tsx**:
- Добавлен `useEffect` для загрузки данных при открытии preview
- Передает `apiDataCache` в `renderBlockClean`

**renderer.tsx**:
- `renderBlockClean` принимает `apiDataCache` параметр
- Использует реальные данные вместо `sample.payload`

**data-binding.ts**:
- `applyDataToBlockProps` работает ТОЛЬКО с явным маппингом
- Автоматический режим полностью удален

**api-client.ts**:
- `fetchApiData()` - делает реальные REST/GraphQL запросы
- Поддержка headers, methods, config

---

## UI Changes

### Инспектор блока

**Было**:
```
[Источник данных]  ← dropdown
[Пример данных]    ← dropdown
[Тест запроса]     ← кнопка

[Маппинг полей]
[Настроить] ← кнопка для показа/скрытия
```

**Стало**:
```
[Источник данных]                    ← dropdown
[Схема данных (для выбора полей)]   ← dropdown
[Обновить данные] [Отключить]       ← кнопки

✓ Данные загружены из API
{реальный JSON ответ}

[Маппинг полей API]
Всегда видны dropdown'ы для каждого поля
```

---

## Что проверить

1. **Canvas**: Выбери source → данные загружаются автоматически
2. **Маппинг**: Настрой поля → блок обновляется с данными
3. **Preview**: Открой /preview → делает свои запросы к API
4. **Ошибки**: Неверный endpoint → показывает ошибку
5. **Обновление**: Кнопка "Обновить" → перезагружает данные

---

## Что НЕ изменилось

- DataSource CRUD (создание/редактирование источников)
- Sample CRUD (добавление примеров схемы)
- Сохранение canvas state
- Экспорт кода
- Все остальные функции Studio

---

## Возможные ошибки

### CORS ошибка
Если API не поддерживает CORS, запрос заблокируется браузером.

**Решение**: Используй API с CORS или прокси.

### Неверная схема
Если sample не совпадает с реальным ответом API, маппинг может не работать.

**Решение**: Обнови sample чтобы он соответствовал реальной структуре.

### Медленный API
Если API отвечает долго, блок будет пустым пока данные загружаются.

**Решение**: Добавь индикаторы загрузки (TODO).

---

## Итог

**Раньше**: Sample = данные блока
**Теперь**: Sample = схема для выбора полей, реальные данные = из API

Всё работает автоматически - просто выбери source и настрой поля!
